#! /usr/bin/env python3

import argparse
import os
from pathlib import Path
from subprocess import run
from typing import TYPE_CHECKING

import tomllib
from bs4 import BeautifulSoup, Tag


if TYPE_CHECKING:
    from collections.abc import Sequence


def main():
    parser = argparse.ArgumentParser()

    parser.add_argument("control_file", metavar="CONTROL.TOML")
    parser.add_argument(
                 "-o", "--output-dir",
                 default=os.path.expanduser("~/nc/ereader/to/vorlesen/"))

    args = parser.parse_args()

    with open(args.control_file, "rb") as cf:
        control = tomllib.load(cf)

    outpath = Path(args.output_dir)

    for folder, filenames in control.items():
        filenames: Sequence[str]
        for filename in filenames:
            filename = Path(filename).absolute()
            with open(filename) as inf:
                html = inf.read()
            soup = BeautifulSoup(html, "html.parser")

            for div in soup.find_all("div", {"class": "story_pdf"}):
                div.decompose()

            h1, = soup.find_all("h1")[-1:]
            assert h1.parent is not None
            geschichte_div = h1.parent.parent

            if geschichte_div is None:
                raise ValueError("story div not found")

            content: list[str] = []

            def recurse(el: Tag):
                if el.name == "div":
                    for ch in el.contents:
                        # assert isinstance(ch, Tag), ch
                        if isinstance(ch, Tag):
                            recurse(ch)
                elif el.name in ["h1", "h2"]:
                    lev = int(el.name[1:])
                    content.append(f"{'#' * lev} {el.text}")
                elif el.name == "img":
                    src = el.attrs["src"]
                    if "reader_light" in src:
                        return

                    content.append(f"![]({src})")
                elif el.name == "span":
                    if el.text.startswith("Du hast Lust auf noch mehr"):
                        return

                    content.append(el.text)
                elif el.name in ["a", "svg", "button"]:
                    return
                else:
                    raise ValueError(f"unexpected tag type: '{el.name}'")

            recurse(geschichte_div)
            print("\n".join(content))

            soup_filename = filename.parent / f"{filename.stem}-soup.html"
            with open(soup_filename, "w") as outf:
                outf.write(soup.prettify())

            clean_filename = filename.parent / f"{filename.stem}.md"
            with open(clean_filename, "w") as outf:
                outf.write("\n\n".join(content))

            outpath_story = outpath / folder
            outpath_story.mkdir(parents=True, exist_ok=True)
            pandoc_cmdline = ["pandoc", clean_filename,
                "-o", str(outpath_story / (filename.stem + ".epub"))]
            print(pandoc_cmdline)
            run(pandoc_cmdline,
                cwd=clean_filename.parent, check=True)


if __name__ == "__main__":
    main()
