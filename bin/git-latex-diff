#! /bin/bash

set -eo pipefail

if test "$2" = ""; then
  echo "usage: $0 REVISION MAINFILE"
  exit 1
fi

REV="$1"
MAIN_FILE="$2"

PARSED_REV="$( git rev-parse --short "$REV")"
OLD_FILE="${MAIN_FILE%.tex}-old-$REV.tex"
DIFF_FILE="${MAIN_FILE%.tex}-diff-$PARSED_REV..$(git rev-parse --short HEAD).tex"

if test -f "$OLD_FILE"; then
  echo "$OLD_FILE already exists, quitting"
  exit 1
fi

git show "$REV:$MAIN_FILE" > "$OLD_FILE"
latexdiff "$OLD_FILE" "$MAIN_FILE" > "$DIFF_FILE"
rm "$OLD_FILE"
echo "Created: $DIFF_FILE"
