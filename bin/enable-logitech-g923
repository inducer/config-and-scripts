#! /bin/bash

# Source: https://github.com/ZRtmWrJqXcjbqBLIMBYMCeUw/Logitech-G923-Linux-Kernel-Driver/issues/5#issuecomment-3094812101

set -exo pipefail

if command -v steamos-readonly > /dev/null; then
  steamos-readonly disable
  pacman-key --init
  pacman-key --populate
  pacman -S usb_modeswitch
fi

cat > /etc/usb_modeswitch.d/046d:c26d <<EOF
# Logitech G923 Racing Wheel
DefaultVendor=0x046d
DefaultProduct=0xc26d
TargetClass=0x03
TargetVendor=0x046d
TargetProduct=0xc26e
MessageEndpoint=0x01
ResponseEndpoint=0x81
MessageContent="0f00010142"
EOF

cat > /etc/udev/rules.d/98-logitech-wheel-perms.rules <<EOF
# Logitech G923 Racing Wheel

ACTION=="add", SUBSYSTEM=="usb", ATTR{idVendor}=="046d", ATTR{idProduct}=="c26d", MODE="0666", RUN+="/usr/bin/usb_modeswitch -c '/etc/usb_modeswitch.d/046d:c26d'"

ACTION=="add|change", KERNEL=="hidraw*", SUBSYSTEM=="hidraw", ATTRS{idVendor}=="046d",
ATTRS{idProduct}=="c26e", GROUP="games", MODE="0666"
EOF
